<!-- 省略：head/body/フォームはそのままでOK -->

<div id="status" style="white-space:pre-wrap; margin-top:12px; color:#333;"></div>

<script>
  const LIFF_ID = "2008827601-tuSCkhGz";

  const $status = document.getElementById("status");
  function log(msg) { $status.textContent += msg + "\n"; }

  async function boot() {
    await liff.init({ liffId: LIFF_ID });

    log("LIFF init: OK");
    log("isInClient: " + liff.isInClient());
    log("isLoggedIn: " + liff.isLoggedIn());

    if (!liff.isLoggedIn()) {
      log("login required -> liff.login()");
      liff.login();
      return;
    }

    const granted = await liff.permission.getGrantedAll();
    log("granted scopes: " + JSON.stringify(granted));
  }

  function buildMessage({ want, maker, city }) {
    return [
      "【見積依頼】",
      `・見積希望内容：${want}`,
      `・メーカー：${maker}`,
      `・設置場所（市町村）：${city}`
    ].join("\n");
  }

  document.getElementById("form").addEventListener("submit", async (e) => {
    e.preventDefault();
    $status.textContent = "";

    const want = document.getElementById("want").value.trim();
    const maker = document.getElementById("maker").value.trim();
    const city = document.getElementById("city").value.trim();

    try {
      if (!liff.isInClient()) {
        throw new Error("LINEアプリ内で開いていません（リッチメニューから開き直してください）");
      }

      // ★ここが重要：ユーザーが chat_message.write を許可していない場合がある
      const granted = await liff.permission.getGrantedAll();
      if (!granted.includes("chat_message.write")) {
        log("requesting permissions...");
        await liff.permission.requestAll(); // 同意画面を出す
      }

      // 再チェック
      const granted2 = await liff.permission.getGrantedAll();
      log("granted scopes(after): " + JSON.stringify(granted2));
      if (!granted2.includes("chat_message.write")) {
        throw new Error("chat_message.write が許可されていません（同意しないとトークに送れません）");
      }

      await liff.sendMessages([{ type: "text", text: buildMessage({ want, maker, city }) }]);
      log("sendMessages: OK");
      liff.closeWindow();
    } catch (err) {
      log("ERROR: " + (err?.message || JSON.stringify(err)));
      // 送信失敗時は閉じない（エラーが見えるように）
    }
  });

  boot().catch(err => log("INIT ERROR: " + (err?.message || JSON.stringify(err))));
</script>
